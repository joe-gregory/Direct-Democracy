<%- include('./partials/head.ejs') %>
<%- include('./partials/navigation.ejs') %>
<h1 class = 'pageTitle'> Mi Comunidad </h1>

<div class = 'container'>
    <div class ='mb-3'>
        <h5 class = 'h5'><a href='/mycommunity/about'>Informacion sobre tu comunidad</a></h3>
        <h5 class = 'h5'><a href = '/mycommunity/createproposal'>Crear nueva propuesta</a></h3>
    </div>
</div>

<% if(communities.length > 1) {%>
<div class = "mb-3">
    <label class = 'form-label' for = 'communities'>Elige comunidad</label>
    <select id="communities" name="communities">
        <%- `<option val="${communities[0].id}" selected>${communities[0].name}</option>` %>
        <% for(let i = 1; i < communities.length; i++){ %>
            <%- `<option val="${communities[i].id}">${communities[i].name}</option>` %>
        <% } %>
    </select>
</div>
<% } %>

<div class = 'mb-3 pt-3'>
    <%- `<h2>Actividad de comunidad ${communities[index].name}</h2>` %>
</div>

<% for(let i = communities[index].proposals.length - 1; i >= 0 ; i--) { %>
    <%-'<div class = "mb-3 feed-unit">'%>
        <%-`<form action = "/mycommunity/vote/${communities[index].proposals[i].id}" method = "post">` %>
            <% let author_residency_index = communities[index].proposals[i].author.residencies.findIndex(element => element.community.id == communities[index].id)%>
            <%-`<p class = "greenParagraphs"> ${communities[index].proposals[i].author.fullName} de la casa #${communities[index].proposals[i].author.residencies[author_residency_index].home.innerNumber} ha propuesto: </p>`%>
            <% switch(communities[index].proposals[i].type){ %>
                <%case 'createLaw': %>
                    <%-`<p>La creacion de una nueva ley </p>` %>
                    <%break; %>
            <% } %>
            <!--la informacion de la propuesta (de proposal title a law body) es collapsable. Y abajo hay otra caja que aparece con la info de si ya paso, si no, votos a favor, contra, no votado y los botones para votar.-->

            <!--Lo viejo de aqui para abajo, replace-->
            <%- (locals.proposals[i].type == 'create') ? `<p>La <b><u>creacion</u></b> de una nueva ley:</p>` : `<p>La <b><u>eliminacion</u></b> de la ley #${locals.proposals[i].lawNumber || locals.proposals[i].originalLawNumber}</p>` %>
            <% if(locals.proposals[i].passed == true){ %>
                <%-`<p class = 'passedMessage'><b>PROPUESTA APROBADA POR LA COMUNIDAD EN ${locals.proposals[i].passedDate.toLocaleDateString("en-US")}</b></p>` %>
            <% }else if (locals.proposals[i].passed == false) { %>
                <%- `<p class = 'passedMessage'><b>PROPUESTA RECHAZADA POR LA COMUNIDAD EN ${locals.proposals[i].passedDate.toLocaleDateString("en-US")}</b></p>`%>
            <% } %>

            <%- (locals.proposals[i].type == 'create') ? `<p><i>${locals.proposals[i].proposal}</i></p>` : `<p><i>${locals.proposals[i].lawText}</i></p>`%>
            <%- `<p><b>Fecha de creacion de propuesta: </b>${(locals.proposals[i].createdAt != undefined) ? locals.proposals[i].createdAt.toLocaleDateString("en-US") : ''}</p>` %>
            <%- `<p><b>Votos a favor:</b> ${locals.proposals[i].votesInFavor} <b>Votos en contra:</b> ${locals.proposals[i].votesAgainst} <b>Sin Votar:</b> ${locals.community.innerHomes.length - locals.proposals[i].votesInFavor - locals.proposals[i].votesAgainst}</p>`%>
            <% if (locals.proposals[i].alreadyVoted == false) { %>
                <%- '<button class = "btn btn-success" name = "voteButton" value = "accept" type = "submit" data-proposalID = ${locals.proposals[i].id}>Aprovar</button>'%>
                <%- '<button class = "btn btn-danger" name = "voteButton" value = "reject" type = "submit">Rechazar</button>'%>
            <% }else { %>
                <%- (locals.proposals[i].votedValue == true) ? `<p>Aceptaste la propuesta &#9989</p>` : `<p>Rechazaste la propuesta &#10060</p>` %>
                <%-`<p class = "greenParagraphs"><b><i><u>Gracias por participar!</u></i></b>` %>
            <% } %>
        
        <%-'</form>' %>
    <%- '</div>' %>
<%} %>


<script src = "/scripts/mycommunity.js"

<%- include('./partials/footer.ejs') %>